<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CFB Grambling</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0f1c;
            color: white;
            padding-bottom: 80px;
            overscroll-behavior: none;
        }
        
        /* Navigation Bubbles */
        .nav-bubbles {
            display: flex;
            justify-content: center;
            gap: 0.75rem;
            padding: 1rem;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(51, 65, 85, 0.5);
            position: sticky;
            top: 0;
            z-index: 100;
            overflow-x: auto;
        }
        
        .nav-bubble {
            background: rgba(51, 65, 85, 0.4);
            border: 1px solid rgba(71, 85, 105, 0.5);
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            font-size: 0.85rem;
            font-weight: 500;
            color: #e2e8f0;
        }
        
        .nav-bubble:hover {
            background: rgba(71, 85, 105, 0.6);
        }
        
        .nav-bubble.active {
            background: linear-gradient(135deg, #1d4ed8, #1e40af);
            border-color: #1d4ed8;
            color: white;
        }
        
        .nav-bubble.admin {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            border-color: #dc2626;
        }

        .nav-bubble.logout-btn {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            border-color: #dc2626;
            margin-left: auto;
        }
        
        /* Main Content */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        /* Game Cards - FanDuel Style */
        .game-card {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(71, 85, 105, 0.4);
            border-radius: 0.75rem;
            margin-bottom: 0.75rem;
            overflow: hidden;
        }
        
        .game-header {
            background: rgba(15, 23, 42, 0.8);
            padding: 0.75rem 1rem;
            border-bottom: 1px solid rgba(71, 85, 105, 0.4);
        }
        
        .game-matchup {
            font-weight: 600;
            color: #e2e8f0;
            font-size: 0.95rem;
        }
        
        .game-time {
            color: #94a3b8;
            font-size: 0.8rem;
            margin-top: 0.25rem;
        }
        
        .team-row {
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            align-items: center;
            padding: 0.75rem 1rem;
            gap: 0.75rem;
            border-bottom: 1px solid rgba(71, 85, 105, 0.2);
        }
        
        .team-row:last-child {
            border-bottom: none;
        }
        
        .team-name {
            font-weight: 600;
            color: #e2e8f0;
            font-size: 0.9rem;
        }
        
        .bet-option {
            background: rgba(71, 85, 105, 0.3);
            border: 1px solid rgba(100, 116, 139, 0.4);
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.8rem;
            font-weight: 500;
            text-align: center;
            min-width: 65px;
            color: #e2e8f0;
        }
        
        .bet-option:hover {
            background: rgba(71, 85, 105, 0.5);
            border-color: rgba(100, 116, 139, 0.6);
        }
        
        .bet-option.selected {
            background: linear-gradient(135deg, #1d4ed8, #1e40af);
            border-color: #1d4ed8;
            color: white;
        }
        
        .bet-option-disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        /* Bottom Bet Slip */
        .bet-slip-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(71, 85, 105, 0.5);
            padding: 1rem;
            z-index: 200;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .bet-slip-bar.has-bets {
            background: linear-gradient(135deg, #1d4ed8, #1e40af);
            cursor: pointer;
        }
        
        .bet-slip-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .bet-count {
            font-weight: 600;
            font-size: 1rem;
        }
        
        .bet-total {
            font-size: 0.9rem;
            color: #cbd5e1;
        }
        
        /* Bet Slip Modal */
        .bet-slip-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 300;
            display: none;
            overflow-y: auto;
        }
        
        .bet-slip-content {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(15, 23, 42, 0.98);
            border-top-left-radius: 1rem;
            border-top-right-radius: 1rem;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .bet-slip-header {
            padding: 1.5rem 1rem 1rem;
            border-bottom: 1px solid rgba(71, 85, 105, 0.4);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .bet-slip-title {
            font-size: 1.25rem;
            font-weight: 700;
        }
        
        .close-bet-slip {
            background: rgba(71, 85, 105, 0.4);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
        }
        
        /* New Concise Bet Item */
        .bet-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border-bottom: 1px solid rgba(71, 85, 105, 0.3);
        }

        .bet-item-left {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .bet-description {
            font-size: 0.95rem;
            font-weight: 600;
        }

        .bet-payout-calc {
            font-size: 0.8rem;
            color: #94a3b8;
        }
        
        .bet-item-right {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .bet-amount-input {
            background: rgba(71, 85, 105, 0.3);
            border: 1px solid rgba(100, 116, 139, 0.4);
            border-radius: 0.375rem;
            padding: 0.5rem;
            color: white;
            width: 80px;
            text-align: right;
        }
        
        .bet-amount-input:focus {
            outline: none;
            border-color: #1d4ed8;
        }
        
        .bet-amount-input::placeholder {
            color: #64748b;
        }
        
        .remove-bet {
            background: none;
            border: none;
            color: #fca5a5;
            font-size: 1.2rem;
            cursor: pointer;
            line-height: 1;
        }

        .bet-slip-footer {
            padding: 1rem;
            background: rgba(30, 41, 59, 0.8);
        }
        
        /* New styling for the summary section */
        .bet-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: #94a3b8;
        }
        
        .summary-group {
            display: flex;
            gap: 0.25rem;
            align-items: baseline;
        }
        
        .summary-separator {
            color: #475569;
            font-size: 1.2rem;
            font-weight: 300;
            padding: 0 0.5rem;
        }

        .summary-value {
            font-weight: 600;
            color: #cbd5e1;
        }
        
        .submit-btn {
            width: 100%;
            background: linear-gradient(135deg, #16a34a, #15803d);
            border: none;
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .submit-btn:disabled {
            background: rgba(71, 85, 105, 0.4);
            color: #94a3b8;
            cursor: not-allowed;
        }
        
        .validation-message {
            background: rgba(245, 158, 11, 0.2);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: #fbbf24;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.85rem;
            text-align: center;
            margin-top: 0.5rem;
        }
        
        .success-message {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: #6ee7b7;
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
            margin: 1rem 0;
        }
        
        .user-message {
            background: rgba(29, 78, 216, 0.2);
            border: 1px solid rgba(29, 78, 216, 0.3);
            color: #93c5fd;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.85rem;
            margin-top: 1rem;
            text-align: center;
        }

        .edit-btn, .delete-btn {
            background: linear-gradient(135deg, #1d4ed8, #1e40af);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-block;
            margin-top: 1rem;
            margin-right: 0.5rem;
        }
        
        .delete-btn {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
        }
        
        /* Auth Modal */
        .auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            overflow: auto;
        }
        
        .auth-card {
            background: rgba(30, 41, 59, 0.9);
            border: 1px solid rgba(71, 85, 105, 0.5);
            border-radius: 1rem;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            backdrop-filter: blur(20px);
            margin: 20px 0;
        }
        
        .auth-title {
            font-size: 1.5rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 1.5rem;
        }
        
        .input-group {
            margin-bottom: 1rem;
        }
        
        .label {
            display: block;
            color: #94a3b8;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .input {
            width: 100%;
            background: rgba(71, 85, 105, 0.3);
            border: 1px solid rgba(100, 116, 139, 0.4);
            border-radius: 0.5rem;
            padding: 0.75rem;
            color: white;
            font-size: 1rem;
        }
        
        .input:focus {
            outline: none;
            border-color: #1d4ed8;
        }
        
        .input::placeholder {
            color: #64748b;
        }

        /* Hide the spinner arrows from number input */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none;
            margin: 0;
        }
        
        input[type=number] {
            -moz-appearance: textfield;
        }

        .btn {
            width: 100%;
            background: linear-gradient(135deg, #1d4ed8, #1e40af);
            border: none;
            color: white;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-1px);
        }
        
        .btn:disabled {
            background: rgba(71, 85, 105, 0.4);
            color: #94a3b8;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: rgba(71, 85, 105, 0.4);
            border: 1px solid rgba(100, 116, 139, 0.4);
        }

        .btn-tertiary {
            background: rgba(220, 38, 38, 0.4);
            border: 1px solid rgba(220, 38, 38, 0.6);
        }
        
        .error {
            background: rgba(220, 38, 38, 0.2);
            border: 1px solid rgba(220, 38, 38, 0.3);
            color: #fca5a5;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }
        
        .admin-notice {
            background: rgba(245, 158, 11, 0.2);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: #fbbf24;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.85rem;
            margin-top: 1rem;
            text-align: center;
        }
        
        .hidden {
            display: none;
        }

        .select-input {
            width: 100%;
            background: rgba(71, 85, 105, 0.3);
            border: 1px solid rgba(100, 116, 139, 0.4);
            border-radius: 0.5rem;
            padding: 0.75rem;
            color: white;
            font-size: 1rem;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
        }

        .select-input option {
            background-color: #1e293b;
            color: white;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .nav-bubbles {
                gap: 0.5rem;
                padding: 0.75rem 0.5rem;
            }
            
            .nav-bubble {
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
            }
            
            .container {
                padding: 0.75rem;
            }
            
            .team-row {
                grid-template-columns: 1fr auto auto auto;
                gap: 0.5rem;
            }
            
            .bet-option {
                min-width: 55px;
                padding: 0.4rem 0.6rem;
                font-size: 0.75rem;
            }
        }
        
        .bet-card {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(71, 85, 105, 0.4);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }

        .bet-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .bet-details {
            font-weight: 600;
        }

        .bet-odds {
            color: #6ee7b7;
            font-weight: 600;
        }

        .bet-amounts {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: #94a3b8;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <div class="nav-bubbles">
        <div class="nav-bubble active" onclick="showPage('thisWeek', this)">This Week</div>
        <div class="nav-bubble" onclick="showPage('myBets', this)">My Bets</div>
        <div class="nav-bubble" onclick="showPage('currentWeekBets', this)">Current Week Board</div>
        <div class="nav-bubble" onclick="showPage('leaderboard', this)">Season Leaderboard</div>
        <div class="nav-bubble admin hidden" id="adminNav" onclick="showPage('admin', this)">Admin</div>
        <div class="nav-bubble" onclick="showPage('settings', this)">Settings</div>
        <div class="nav-bubble logout-btn" onclick="handleLogout()">Logout</div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- This Week Page -->
        <div id="thisWeek" class="page active">
            <h2 style="margin-bottom: 1rem; color: #e2e8f0;">This Week's Games</h2>
            <div id="gamesContainer">
                <div style="text-align: center; color: #94a3b8; padding: 2rem;">Loading games...</div>
            </div>
        </div>

        <!-- My Bets Page -->
        <div id="myBets" class="page">
            <h2 style="margin-bottom: 1rem; color: #e2e8f0;">My Betting History</h2>
            <p style="color: #94a3b8; margin-bottom: 2rem;">View all your bets and edit current week selections</p>
            <div id="myBetsContainer">
                <div style="text-align: center; color: #94a3b8; padding: 2rem;">Loading your bets...</div>
            </div>
        </div>

        <!-- Current Week's Bets Page -->
        <div id="currentWeekBets" class="page">
            <h2 style="margin-bottom: 1rem; color: #e2e8f0;">Current Week Board</h2>
            <div id="currentWeekBetsContainer">
                <div style="text-align: center; color: #94a3b8; padding: 2rem;">Loading current week's bets...</div>
            </div>
        </div>

        <!-- Leaderboard Page -->
        <div id="leaderboard" class="page">
            <h2 style="margin-bottom: 1rem; color: #e2e8f0;">Season Leaderboard</h2>
            <p style="color: #94a3b8; margin-bottom: 2rem;">Current standings and point totals</p>
            <div id="leaderboardContainer">
                <div style="text-align: center; color: #94a3b8; padding: 2rem;">Loading leaderboard...</div>
            </div>
        </div>

        <!-- Admin Page -->
        <div id="admin" class="page">
            <h2 style="margin-bottom: 1rem; color: #e2e8f0;">Admin Panel</h2>
            <div class="user-message">
                <strong>Current User:</strong> <span id="currentUserInfo"></span>
            </div>
            <div style="display: grid; gap: 2rem; margin-top: 2rem;">
                <div style="background: rgba(30, 41, 59, 0.6); padding: 1.5rem; border-radius: 0.75rem; border: 1px solid rgba(71, 85, 105, 0.4);">
                    <h3 style="margin-bottom: 1rem; color: #e2e8f0;">Load Weekly Odds</h3>
                    <p style="color: #94a3b8; margin-bottom: 1rem; font-size: 0.9rem;">Pull fresh betting lines from the API</p>
                    <button class="btn" onclick="loadOdds()" id="loadOddsBtn">Load Odds</button>
                </div>
                <!-- Section for updating points -->
                <div style="background: rgba(30, 41, 59, 0.6); padding: 1.5rem; border-radius: 0.75rem; border: 1px solid rgba(71, 85, 105, 0.4);">
                    <h3 style="margin-bottom: 1rem; color: #e2e8f0;">Update User Points</h3>
                    <p style="color: #94a3b8; margin-bottom: 1rem; font-size: 0.9rem;">Add or subtract points from a user's total</p>
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <select id="userDropdown" class="select-input">
                            <option value="">Select a user</option>
                        </select>
                        <input type="number" id="pointsInput" class="input" placeholder="Enter points to add/subtract">
                        <button class="btn" onclick="updateUserPoints()" id="updatePointsBtn">Update Points</button>
                    </div>
                    <div id="pointsMessage" class="validation-message hidden" style="margin-top: 1rem;"></div>
                </div>
            </div>
        </div>

        <!-- Settings Page -->
        <div id="settings" class="page">
            <h2 style="margin-bottom: 1rem; color: #e2e8f0;">Game Rules</h2>
            <div style="background: rgba(30, 41, 59, 0.6); padding: 1.5rem; border-radius: 0.75rem; border: 1px solid rgba(71, 85, 105, 0.4); line-height: 1.6;">
                <h3 style="color: #e2e8f0; margin-bottom: 1rem;">How CFB Grambling Works</h3>
                <div style="color: #cbd5e1; margin-bottom: 1.5rem;">
                    <h4 style="color: #e2e8f0; margin-bottom: 0.5rem;">Weekly Betting</h4>
                    <ul style="margin-left: 1.5rem; color: #94a3b8;">
                        <li>New odds loaded every Tuesday at approximately 3 PM ET</li>
                        <li>Place bets until Friday 11 AM ET deadline</li>
                        <li>Must bet exactly $20 total in fake money</li>
                        <li>Choose 3-5 games minimum</li>
                        <li>Minimum $3 per individual bet</li>
                    </ul>
                </div>
                <div style="color: #cbd5e1; margin-bottom: 1.5rem;">
                    <h4 style="color: #e2e8f0; margin-bottom: 0.5rem;">Betting Options</h4>
                    <ul style="margin-left: 1.5rem; color: #94a3b8;">
                        <li>Moneyline OR Spread (not both for same game)</li>
                        <li>Over/Under totals (can combine with moneyline/spread)</li>
                        <li>Edit your bets anytime before Friday deadline</li>
                    </ul>
                </div>
                <div style="color: #cbd5e1;">
                    <h4 style="color: #e2e8f0; margin-bottom: 0.5rem;">Scoring & Points</h4>
                    <ul style="margin-left: 1.5rem; color: #94a3b8;">
                        <li>Weekly winner 50% of the weekly pot</li>
                        <li>Weekly second place gets 20% of the weekly pot</li>
                        <li>20% of the weekly pot goes into the season long pot</li>
                        <li>Winnings accumulate throughout season on the leaderboard</li>
                        <li>The season long winners (minimum 7 weeks played) will be paid out of the season pot - 70%, 20%, 10%</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Bet Slip Bar -->
    <div class="bet-slip-bar" id="betSlipBar" onclick="openBetSlip()">
        <div class="bet-slip-summary">
            <div class="bet-count" id="betCountDisplay">Bet Slip</div>
            <div class="bet-total" id="betTotalDisplay">Select bets to get started</div>
        </div>
    </div>

    <!-- Bet Slip Modal -->
    <div class="bet-slip-modal" id="betSlipModal">
        <div class="bet-slip-content">
            <div class="bet-slip-header">
                <div class="bet-slip-title">Bet Slip</div>
                <button class="close-bet-slip" onclick="closeBetSlip()">√ó</button>
            </div>
            
            <div id="betSlipItems">
                <div style="text-align: center; color: #64748b; padding: 2rem;">No bets selected</div>
            </div>
            
            <div class="bet-slip-footer">
                <div class="bet-summary">
                    <div class="summary-group">
                        <span>Total Wager:</span>
                        <span id="totalWagered" class="summary-value">$0.00</span>
                    </div>
                    <span class="summary-separator">|</span>
                    <div class="summary-group">
                        <span>Remaining:</span>
                        <span id="remainingAmount" class="summary-value">$20.00</span>
                    </div>
                </div>
                
                <button class="submit-btn" id="submitBtn" disabled onclick="submitBets()">Submit Bets</button>
                <div id="validationMessage" class="validation-message hidden"></div>
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="authModal" class="auth-modal">
        <div class="auth-card">
            <div class="auth-title">üèà CFB Grambling</div>
            
            <div id="loginForm">
                <div class="input-group">
                    <label class="label">Your PIN</label>
                    <input type="text" id="loginPin" class="input" placeholder="Enter your PIN">
                </div>
                <button class="btn" onclick="handleLogin()" id="loginBtn">Login</button>
                <button class="btn btn-secondary" onclick="showRegisterForm()">Create Account</button>
            </div>
            
            <div id="registerForm" class="hidden">
                <div class="input-group">
                    <label class="label">Unique PIN (4+ digits)</label>
                    <input type="text" id="registerPin" class="input" placeholder="Enter your unique PIN">
                </div>
                <div class="input-group">
                    <label class="label">Display Name</label>
                    <input type="text" id="registerName" class="input" placeholder="Enter your name">
                </div>
                <button class="btn" onclick="handleRegister()" id="registerBtn">Create Account</button>
                <button class="btn btn-secondary" onclick="showLoginForm()">Back to Login</button>
            </div>
            
            <div id="authError" class="error hidden"></div>
        </div>
    </div>

    <script>
        // Supabase setup
        const SUPABASE_URL = 'https://bumxibdfhturlljvqfnn.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ1bXhpYmRmaHR1cmxsanZxZm5uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NjA2NDMsImV4cCI6MjA3MjIzNjY0M30.3B2SHPrDWYGTYLXUieEoO2Nx40CoOlUD_B-8uIKw21s';
        
        // Global state
        let supabase = null;
        let currentUser = null;
        let betSlip = [];
        let currentWeek = null;
        let oddsData = null;
        const LOGOUT_TIMEOUT = 4 * 60 * 60 * 1000; // 4 hours in milliseconds
        let logoutTimer = null;
        
        // Initialize app on page load
        window.addEventListener('DOMContentLoaded', () => {
            initializeSupabase();
            checkAuth();
            document.getElementById('loginPin').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
            document.getElementById('registerPin').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleRegister();
            });
            document.getElementById('registerName').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleRegister();
            });
            
            // Start the logout timer and add activity listeners
            resetLogoutTimer();
            document.addEventListener('mousemove', resetLogoutTimer);
            document.addEventListener('keydown', resetLogoutTimer);
            document.addEventListener('click', resetLogoutTimer);
        });
        
        function initializeSupabase() {
            try {
                if (window.supabase && window.supabase.createClient) {
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                    console.log('Supabase initialized successfully');
                } else {
                    setTimeout(initializeSupabase, 100);
                }
            } catch (error) {
                console.error('Supabase initialization error:', error);
            }
        }
        
        function checkAuth() {
            const savedUser = localStorage.getItem('cfb_user');
            if (savedUser) {
                const user = JSON.parse(savedUser);
                const lastActivity = parseInt(localStorage.getItem('cfb_last_activity') || '0', 10);
                if (Date.now() - lastActivity > LOGOUT_TIMEOUT) {
                    // Force logout if the session has expired
                    handleLogout();
                } else {
                    currentUser = user;
                    hideAuthModal();
                    updateUserDisplay();
                    loadInitialData();
                }
            } else {
                showAuthModal();
            }
        }
        
        function resetLogoutTimer() {
            clearTimeout(logoutTimer);
            localStorage.setItem('cfb_last_activity', Date.now());
            logoutTimer = setTimeout(() => {
                handleLogout();
            }, LOGOUT_TIMEOUT);
        }
        
        async function loadInitialData() {
            await loadCurrentWeek();
            if (oddsData) {
                // Show all games up to the maximum of 68
                updateGamesDisplay(oddsData.slice(0, 68));
            } else {
                // Display placeholder if no games are available
                document.getElementById('gamesContainer').innerHTML = '<div style="text-align: center; color: #94a3b8; padding: 2rem;">No games available for this week.</div>';
            }
            if (currentUser?.is_admin) {
                loadUsersForAdmin();
            }
            loadMyBets();
            loadCurrentWeeksBets();
            loadLeaderboard();
        }

        function updateUserDisplay() {
            if (currentUser?.is_admin) {
                document.getElementById('adminNav').classList.remove('hidden');
            }
            const userInfoEl = document.getElementById('currentUserInfo');
            if (userInfoEl) {
                userInfoEl.textContent = `${currentUser.name}`;
            }
        }
        
        // Auth Functions
        function showAuthModal() {
            document.getElementById('authModal').style.display = 'flex';
        }
        
        function hideAuthModal() {
            document.getElementById('authModal').style.display = 'none';
        }
        
        function showLoginForm() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            clearAuthError();
        }
        
        function showRegisterForm() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
            clearAuthError();
        }
        
        function clearAuthError() {
            document.getElementById('authError').classList.add('hidden');
            document.getElementById('authError').textContent = '';
        }
        
        function showAuthError(message) {
            const errorEl = document.getElementById('authError');
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
        }
        
        async function handleLogin() {
            const pin = document.getElementById('loginPin').value.trim();
            const btn = document.getElementById('loginBtn');
            clearAuthError();
            if (!supabase) { showAuthError('System not ready. Please wait.'); return; }
            if (!pin) { showAuthError('Please enter your PIN'); return; }
            
            btn.disabled = true;
            btn.textContent = 'Logging in...';
            
            try {
                const { data, error } = await supabase.from('users').select('*').eq('pin', pin).single();
                if (error) throw error;
                currentUser = data;
                localStorage.setItem('cfb_user', JSON.stringify(currentUser));
                localStorage.setItem('cfb_last_activity', Date.now()); // Set initial activity timestamp
                hideAuthModal();
                updateUserDisplay();
                loadInitialData();
            } catch (err) {
                showAuthError('Login failed. Please check your PIN.');
                console.error('Login error:', err);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Login';
            }
        }
        
        async function handleRegister() {
            const pin = document.getElementById('registerPin').value.trim();
            const name = document.getElementById('registerName').value.trim();
            const btn = document.getElementById('registerBtn');
            clearAuthError();
            if (!supabase) { showAuthError('System not ready. Please wait.'); return; }
            if (!pin || !name) { showAuthError('Please fill in all fields'); return; }
            if (pin.length < 4) { showAuthError('PIN must be at least 4 digits'); return; }
            
            btn.disabled = true;
            btn.textContent = 'Creating Account...';
            
            try {
                const { data: existingUser } = await supabase.from('users').select('pin').eq('pin', pin).single();
                if (existingUser) { showAuthError('This PIN is already taken.'); return; }
                
                const isAdmin = (pin === '7717' || pin === '3669');
                const { data, error } = await supabase.from('users').insert([{ pin, name, is_admin: isAdmin, total_points: 0 }]).select();
                if (error) throw error;
                
                currentUser = data[0];
                localStorage.setItem('cfb_user', JSON.stringify(currentUser));
                localStorage.setItem('cfb_last_activity', Date.now()); // Set initial activity timestamp
                hideAuthModal();
                updateUserDisplay();
                loadInitialData();
            } catch (err) {
                showAuthError('Registration failed. Please try again.');
                console.error('Registration error:', err);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Create Account';
            }
        }
        
        function handleLogout() {
            currentUser = null;
            localStorage.removeItem('cfb_user');
            localStorage.removeItem('cfb_last_activity');
            betSlip = [];
            updateBetSlip();
            clearAllSelections();
            document.getElementById('adminNav').classList.add('hidden');
            showAuthModal();
        }
        
        // Navigation
        function showPage(pageId, element) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.nav-bubble').forEach(bubble => bubble.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            if (element) {
                element.classList.add('active');
            } else {
                document.querySelector(`.nav-bubble[onclick*="${pageId}"]`).classList.add('active');
            }

            // Silent refresh for each page
            if (pageId === 'thisWeek') {
                loadCurrentWeek();
            } else if (pageId === 'myBets') {
                loadMyBets();
            } else if (pageId === 'currentWeekBets') {
                loadCurrentWeeksBets();
            } else if (pageId === 'leaderboard') {
                loadLeaderboard();
            } else if (pageId === 'admin' && currentUser?.is_admin) {
                loadUsersForAdmin();
            }
        }
        
        // Betting Logic
        function selectBet(event, gameId, team, type, odds, point, matchup) {
            event.stopPropagation();

            const betKey = `${gameId}-${team}-${type}`;
            const isAlreadySelected = betSlip.some(bet => bet.key === betKey);
            
            // If the user is un-selecting a bet
            if (isAlreadySelected) {
                removeBet(betKey);
                event.currentTarget.classList.remove('selected');
                return;
            }

            // If the user is selecting a new bet
            if (betSlip.length >= 5) {
                showValidationMessage('Maximum 5 bets allowed.');
                return;
            }
            
            // Handle automatic voiding of conflicting bets
            if (type === 'moneyline' || type === 'spread') {
                const conflictingBets = betSlip.filter(bet => bet.gameId === gameId && (bet.type === 'moneyline' || bet.type === 'spread'));
                conflictingBets.forEach(bet => removeBet(bet.key));
            } else if (type === 'total') {
                const conflictingBets = betSlip.filter(bet => bet.gameId === gameId && bet.type === 'total');
                conflictingBets.forEach(bet => removeBet(bet.key));
            }
            
            // Add the new bet to the slip
            const newBet = { key: betKey, gameId, team, type, odds, point, matchup, amount: 0 };
            betSlip.push(newBet);
            event.currentTarget.classList.add('selected');
            
            updateBetSlip();
        }

        function removeBet(betKey) {
            const index = betSlip.findIndex(bet => bet.key === betKey);
            if (index !== -1) {
                const element = document.querySelector(`[data-bet="${betKey}"]`);
                if (element) element.classList.remove('selected');
                betSlip.splice(index, 1);
                updateBetSlip();
            }
        }
        
        function updateBetAmount(betKey, amount) {
            const bet = betSlip.find(b => b.key === betKey);
            if (bet) {
                bet.amount = parseFloat(amount) || 0;
            }
            updateBetSlipSummary();
            updateBetSlip();
            validateBets();
        }
        
        function calculatePayout(odds, amount) {
            const oddsNum = parseFloat(odds);
            if (isNaN(oddsNum) || amount <= 0) return 0;

            if (oddsNum > 0) {
                return amount * (oddsNum / 100);
            } else if (oddsNum < 0) {
                return amount / (Math.abs(oddsNum) / 100);
            }
            return 0;
        }

        function updateBetSlip() {
            const betSlipBar = document.getElementById('betSlipBar');
            const betCountDisplay = document.getElementById('betCountDisplay');
            const betTotalDisplay = document.getElementById('betTotalDisplay');
            const betSlipItems = document.getElementById('betSlipItems');
            
            if (betSlip.length === 0) {
                betSlipBar.classList.remove('has-bets');
                betCountDisplay.textContent = 'Bet Slip';
                betTotalDisplay.textContent = 'Select bets to get started';
                betSlipItems.innerHTML = '<div style="text-align: center; color: #64748b; padding: 2rem;">No bets selected</div>';
            } else {
                betSlipBar.classList.add('has-bets');
                const total = betSlip.reduce((sum, bet) => sum + (bet.amount || 0), 0);
                betCountDisplay.textContent = `Bet Slip (${betSlip.length})`;
                betTotalDisplay.textContent = `$${total.toFixed(2)} / $20.00`;
                
                betSlipItems.innerHTML = betSlip.map(bet => {
                    const potentialPayout = calculatePayout(bet.odds, bet.amount);
                    let description;
                    if (bet.type === 'moneyline') {
                        description = `${bet.team} Moneyline`;
                    } else if (bet.type === 'spread') {
                        const pointFormatted = bet.point > 0 ? `+${bet.point}` : bet.point;
                        description = `${bet.team} ${pointFormatted}`;
                    } else if (bet.type === 'total') {
                        description = `${bet.matchup} ${bet.team === 'Over' ? 'Over' : 'Under'} ${bet.point}`;
                    }
                    const payoutText = `Potential Payout: $${potentialPayout.toFixed(2)}`;

                    return `
                        <div class="bet-item">
                            <div class="bet-item-left">
                                <div class="bet-description">${description}</div>
                                <div class="bet-payout-calc">${payoutText}</div>
                            </div>
                            <div class="bet-item-right">
                                <input type="number" 
                                    class="bet-amount-input" 
                                    min="0" 
                                    max="20" 
                                    value="${bet.amount > 0 ? bet.amount : ''}"
                                    placeholder="$"
                                    onblur="updateBetAmount('${bet.key}', this.value)"
                                    onkeydown="if(event.key==='Enter') { this.blur(); }">
                                <button class="remove-bet" onclick="removeBet('${bet.key}')">√ó</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            updateBetSlipSummary();
            validateBets();
        }
        
        function updateBetSlipSummary() {
            const total = betSlip.reduce((sum, bet) => sum + (bet.amount || 0), 0);
            const remaining = 20 - total;
            
            document.getElementById('totalWagered').textContent = `$${total.toFixed(2)}`;
            document.getElementById('remainingAmount').textContent = `$${remaining.toFixed(2)}`;
        }
        
        function validateBets() {
            const total = betSlip.reduce((sum, bet) => sum + (bet.amount || 0), 0);
            const submitBtn = document.getElementById('submitBtn');
            const validationMessage = document.getElementById('validationMessage');
            let isValid = true;
            let message = '';
            
            if (betSlip.length < 3) {
                isValid = false;
                message = `Add ${3 - betSlip.length} more bet${3 - betSlip.length > 1 ? 's' : ''} to meet the minimum of 3.`;
            } else if (betSlip.length > 5) {
                isValid = false;
                message = 'You have too many bets! The maximum is 5.';
            } else if (Math.abs(total - 20) > 0.01) {
                isValid = false;
                if (total < 20) {
                    message = `Add $${(20 - total).toFixed(2)} more to reach the $20 total.`;
                } else {
                    message = `Remove $${(total - 20).toFixed(2)} to reach the $20 total.`;
                }
            } else if (betSlip.some(bet => (bet.amount || 0) < 3)) {
                isValid = false;
                message = 'All bets must be at least $3.';
            }
            
            submitBtn.disabled = !isValid;
            
            if (message) {
                validationMessage.textContent = message;
                validationMessage.classList.remove('hidden');
            } else {
                validationMessage.classList.add('hidden');
            }
        }
        
        function showValidationMessage(message) {
            const validationMessage = document.getElementById('validationMessage');
            validationMessage.textContent = message;
            validationMessage.classList.remove('hidden');
            setTimeout(() => {
                validationMessage.classList.add('hidden');
            }, 3000);
        }
        
        function clearAllSelections() {
            betSlip = [];
            document.querySelectorAll('.bet-option').forEach(option => {
                option.classList.remove('selected');
            });
            updateBetSlip();
        }
        
        // Bet Slip Modal
        function openBetSlip() {
            document.getElementById('betSlipModal').style.display = 'block';
        }
        
        function closeBetSlip() {
            document.getElementById('betSlipModal').style.display = 'none';
        }
        
        async function submitBets() {
            if (!currentUser || !supabase || !currentWeek) return;
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';
            
            try {
                // Delete existing bets for the current week and user
                await supabase.from('user_bets').delete().eq('user_pin', currentUser.pin).eq('week_id', currentWeek.id);
                
                const betsToInsert = betSlip.map(bet => ({
                    user_pin: currentUser.pin,
                    week_id: currentWeek.id,
                    game_id: bet.gameId,
                    team_picked: bet.team,
                    bet_amount: bet.amount,
                    odds: bet.odds,
                    bet_type: bet.type,
                    point_value: bet.point,
                    teams: bet.matchup,
                    last_updated_at: new Date().toISOString()
                }));
                
                const { error } = await supabase.from('user_bets').insert(betsToInsert);
                if (error) throw error;
                
                const successDiv = document.createElement('div');
                successDiv.className = 'success-message';
                successDiv.textContent = `Successfully submitted your bets for Week ${currentWeek.week_number}!`;
                document.getElementById('betSlipItems').prepend(successDiv);

                clearAllSelections();
                
                setTimeout(() => {
                    closeBetSlip();
                    loadMyBets();
                    loadCurrentWeeksBets();
                }, 2000);
            } catch (err) {
                showValidationMessage('Failed to submit bets: ' + err.message);
                console.error('Submission error:', err);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Bets';
            }
        }

        async function loadCurrentWeek() {
            try {
                const { data, error } = await supabase
                    .from('betting_weeks')
                    .select('*')
                    .eq('is_active', true)
                    .single();
                
                if (error && error.code !== 'PGRST116') throw error; // PGRST116 is no rows
                
                if (data) {
                    currentWeek = data;
                    oddsData = data.api_data.games;
                    updateGamesDisplay(oddsData);
                    console.log('Loaded active week:', currentWeek);
                } else {
                    currentWeek = null;
                    oddsData = null;
                    document.getElementById('gamesContainer').innerHTML = '<div style="text-align: center; color: #94a3b8; padding: 2rem;">No games available for this week. Admin must load them.</div>';
                }
            } catch (err) {
                console.error('Error loading current week:', err);
            }
        }
        
        async function loadMyBets() {
            if (!currentUser) {
                console.log('Not logged in, skipping bet loading.');
                return;
            }
            const container = document.getElementById('myBetsContainer');
            container.innerHTML = '<div style="text-align: center; color: #94a3b8; padding: 2rem;">Loading your bets...</div>';

            try {
                // Fetch all bets for the current user
                const { data, error } = await supabase
                    .from('user_bets')
                    .select('*, betting_weeks(week_number, betting_deadline)')
                    .eq('user_pin', currentUser.pin);
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: #94a3b8; padding: 2rem;">You have not placed any bets yet.</div>';
                    return;
                }
                
                // Sort the data to ensure the most recent bets are first
                data.sort((a, b) => {
                    const weekComparison = b.week_id - a.week_id;
                    if (weekComparison !== 0) {
                        return weekComparison;
                    }
                    return new Date(b.last_updated_at) - new Date(a.last_updated_at);
                });

                // Group bets by week_id
                const groupedBets = data.reduce((acc, bet) => {
                    const weekId = bet.week_id;
                    if (!acc[weekId]) {
                        acc[weekId] = {
                            week_number: bet.betting_weeks.week_number,
                            deadline: new Date(bet.betting_weeks.betting_deadline),
                            bets: []
                        };
                    }
                    acc[weekId].bets.push(bet);
                    return acc;
                }, {});

                container.innerHTML = Object.values(groupedBets).map(week => {
                    const isCurrentWeek = currentWeek && week.bets[0].week_id === currentWeek.id;
                    const isEditable = isCurrentWeek && new Date() < week.deadline;
                    
                    return `
                        <div class="game-card" style="margin-bottom: 2rem;">
                            <div class="game-header">
                                <div class="game-matchup"><strong>Week ${week.week_number} Bets</strong></div>
                                ${isEditable ? `<div class="game-time" style="color:#6ee7b7;">Active: Editable until ${week.deadline.toLocaleDateString()} at ${week.deadline.toLocaleTimeString()}</div>` : `<div class="game-time">Locked in: ${week.deadline.toLocaleDateString()}</div>`}
                            </div>
                            <div style="padding: 1rem;">
                                ${week.bets.map(bet => {
                                    const potentialPayout = calculatePayout(bet.odds, bet.bet_amount);
                                    let betDetails = '';
                                    let displayOdds = bet.odds;
                                    
                                    // Override odds for display purposes
                                    if (bet.bet_type === 'spread' || bet.bet_type === 'total') {
                                        displayOdds = '-110';
                                    }

                                    if (bet.bet_type === 'moneyline') {
                                        betDetails = `${bet.team_picked} Moneyline (${displayOdds})`;
                                    } else if (bet.bet_type === 'spread') {
                                        const pointFormatted = bet.point_value > 0 ? `+${bet.point_value}` : bet.point_value;
                                        betDetails = `${bet.team_picked} ${pointFormatted} (${displayOdds})`;
                                    } else if (bet.bet_type === 'total') {
                                        betDetails = `${bet.teams} ${bet.team_picked === 'Over' ? 'Over' : 'Under'} ${bet.point_value} (${displayOdds})`;
                                    }
                                    
                                    return `
                                        <div class="bet-item">
                                            <div class="bet-item-left">
                                                <div class="bet-description">${betDetails}</div>
                                                <div class="bet-payout-calc">Wager: $${bet.bet_amount.toFixed(2)} | Payout: $${potentialPayout.toFixed(2)}</div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                                ${isEditable ? `<button class="edit-btn" onclick="editMyCurrentBets()">Edit Bets</button><button class="delete-btn" onclick="deleteMyCurrentBets()">Delete All Bets</button>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (err) {
                container.innerHTML = `<div style="text-align: center; color: #fca5a5; padding: 2rem;">Failed to load your bets.</div>`;
                console.error('Error loading my bets:', err);
            }
        }
        
        async function deleteMyCurrentBets() {
            if (!currentUser) return;

            // Use a custom confirmation message to avoid browser alerts
            const confirmation = confirm('Are you sure you want to delete all your bets for this week? This cannot be undone.');
            if (!confirmation) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('user_bets')
                    .delete()
                    .eq('user_pin', currentUser.pin)
                    .eq('week_id', currentWeek.id);
                
                if (error) throw error;
                
                alert('All your bets for this week have been deleted successfully.');
                loadMyBets();
            } catch (err) {
                alert('Failed to delete bets: ' + err.message);
                console.error('Deletion error:', err);
            }
        }

        async function loadCurrentWeeksBets() {
            const container = document.getElementById('currentWeekBetsContainer');
            const pageHeader = document.querySelector('#currentWeekBets h2');
            container.innerHTML = '<div style="text-align: center; color: #94a3b8; padding: 2rem;">Loading current week\'s bets...</div>';
            pageHeader.textContent = 'Current Week Board'; // Reset title while loading

            try {
                // Find the week with the most recent past betting deadline
                const { data: recentWeekData, error: weekError } = await supabase
                    .from('betting_weeks')
                    .select('id, betting_deadline')
                    .lt('betting_deadline', new Date().toISOString())
                    .order('betting_deadline', { ascending: false })
                    .limit(1)
                    .single();

                if (weekError && weekError.code !== 'PGRST116') throw weekError;

                if (!recentWeekData) {
                    container.innerHTML = '<div style="text-align: center; color: #94a3b8; padding: 2rem;">No previous week\'s bets to display yet.</div>';
                    return;
                }

                const deadlineDate = new Date(recentWeekData.betting_deadline);
                const formattedDate = deadlineDate.toLocaleDateString('en-US');
                pageHeader.textContent = `Picks for the Weekend of ${formattedDate}`;

                // Fetch bets for that specific week
                const { data: bets, error: betsError } = await supabase
                    .from('user_bets')
                    .select('*, users(name), betting_weeks(week_number)')
                    .eq('week_id', recentWeekData.id);
                if (betsError) throw betsError;

                // Fetch bet results for the week
                const { data: results, error: resultsError } = await supabase
                    .from('bet_results')
                    .select('*')
                    .eq('week_id', recentWeekData.id);
                if (resultsError) throw resultsError;

                // Map results for quick lookup
                const resultsMap = {};
                results.forEach(r => {
                    resultsMap[`${r.user_pin}_${r.game_id}_${r.bet_type}_${r.team_picked}`] = r;
                });

                // Group bets by user
                const groupedBets = bets.reduce((acc, bet) => {
                    const user = acc[bet.user_pin] || { name: bet.users.name, bets: [] };
                    user.bets.push(bet);
                    acc[bet.user_pin] = user;
                    return acc;
                }, {});

                // Calculate winnings for each user
                Object.values(groupedBets).forEach(user => {
                    user.totalWinnings = 0;
                    user.bets.forEach(bet => {
                        const resultKey = `${bet.user_pin}_${bet.game_id}_${bet.bet_type}_${bet.team_picked}`;
                        const result = resultsMap[resultKey];
                        if (result && result.is_win === true) {
                            user.totalWinnings += calculatePayout(bet.odds, bet.bet_amount);
                        }
                    });
                });

                // Sort users by total winnings
                const sortedUsers = Object.values(groupedBets).sort((a, b) => b.totalWinnings - a.totalWinnings);

                container.innerHTML = sortedUsers.map(user => `
                    <div class="game-card">
                        <div class="game-header" style="background: none; border-bottom: none; padding-bottom: 0;">
                            <div class="game-matchup"><strong>${user.name}'s Bets</strong></div>
                            <div style="font-weight: bold; color: #6ee7b7;">Total Winnings: $${user.totalWinnings.toFixed(2)}</div>
                        </div>
                        <div style="padding: 0.75rem 1rem;">
                            ${user.bets.map(bet => {
                                let betDetails = '';
                                let displayOdds = bet.odds;
                                const potentialWinnings = calculatePayout(bet.odds, bet.bet_amount) - bet.bet_amount;
                                const resultKey = `${bet.user_pin}_${bet.game_id}_${bet.bet_type}_${bet.team_picked}`;
                                const result = resultsMap[resultKey];

                                if (bet.bet_type === 'spread' || bet.bet_type === 'total') {
                                    displayOdds = '-110';
                                }

                                if (bet.bet_type === 'moneyline') {
                                    betDetails = `${bet.teams} - ${bet.team_picked} ML`;
                                } else if (bet.bet_type === 'spread') {
                                    const pointFormatted = bet.point_value > 0 ? `+${bet.point_value}` : bet.point_value;
                                    betDetails = `${bet.teams} - ${bet.team_picked} ${pointFormatted}`;
                                } else if (bet.bet_type === 'total') {
                                    betDetails = `${bet.teams} - ${bet.team_picked} ${bet.point_value}`;
                                }

                                // Color and admin controls
                                let color = '#94a3b8';
                                if (result && result.is_win === true) color = '#22c55e'; // green
                                if (result && result.is_win === false) color = '#ef4444'; // red

                                let adminControls = '';
                                if (currentUser?.is_admin) {
                                    adminControls = `
                                        <span style="margin-left:1rem;">
                                            <button style="background:#22c55e;color:white;border:none;padding:0.2rem 0.6rem;border-radius:0.3rem;cursor:pointer;" onclick="markBetResult('${bet.user_pin}','${bet.game_id}','${bet.bet_type}','${bet.team_picked}',true)">Win</button>
                                            <button style="background:#ef4444;color:white;border:none;padding:0.2rem 0.6rem;border-radius:0.3rem;cursor:pointer;" onclick="markBetResult('${bet.user_pin}','${bet.game_id}','${bet.bet_type}','${bet.team_picked}',false)">Loss</button>
                                        </span>
                                    `;
                                }

                                return `
                                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; padding: 0.5rem 0; border-bottom: 1px solid rgba(71, 85, 105, 0.2); color:${color};">
                                        <div style="font-weight: 500;">
                                            ${betDetails} <span style="color: #6ee7b7; font-weight: 600;">(${displayOdds})</span>
                                            ${adminControls}
                                        </div>
                                        <div style="font-size: 0.85rem; text-align: right;">
                                            Wager: $${bet.bet_amount.toFixed(2)}<br>
                                            Payout: $${(bet.bet_amount + potentialWinnings).toFixed(2)}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                container.innerHTML = `<div style="text-align: center; color: #fca5a5; padding: 2rem;">Failed to load current week's bets.</div>`;
                console.error('Error loading current week bets:', err);
            }
        }
        
        async function editMyCurrentBets() {
            if (!currentUser) return;
            try {
                const { data, error } = await supabase
                    .from('user_bets')
                    .select('*')
                    .eq('user_pin', currentUser.pin)
                    .eq('week_id', currentWeek.id);
                if (error) throw error;
                
                if (data.length > 0) {
                    clearAllSelections();
                    data.forEach(bet => {
                        const betKey = `${bet.game_id}-${bet.team_picked}-${bet.bet_type}`;
                        const matchingOption = document.querySelector(`[data-bet="${betKey}"]`);
                        
                        if (matchingOption) {
                            betSlip.push({
                                key: betKey,
                                gameId: bet.game_id,
                                team: bet.team_picked,
                                type: bet.bet_type,
                                odds: bet.odds,
                                point: bet.point_value,
                                matchup: bet.teams, // Use the teams field from the database
                                amount: bet.bet_amount
                            });
                            matchingOption.classList.add('selected');
                        }
                    });
                    updateBetSlip();
                    openBetSlip();
                    showPage('thisWeek');
                } else {
                    showValidationMessage('No bets found for this week to edit.');
                }
            } catch (err) {
                showValidationMessage('Failed to load bets for editing.');
                console.error('Error editing bets:', err);
            }
        }

        async function loadLeaderboard() {
            const container = document.getElementById('leaderboardContainer');
            container.innerHTML = '<div style="text-align: center; color: #94a3b8; padding: 2rem;">Loading leaderboard...</div>';

            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .order('total_points', { ascending: false });
                if (error) throw error;
                
                if (data.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: #94a3b8; padding: 2rem;">No users found.</div>';
                    return;
                }

                container.innerHTML = data.map((user, index) => `
                    <div class="game-card" style="display: flex; justify-content: space-between; align-items: center; padding: 1rem;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="font-size: 1.2rem; font-weight: bold; color: #94a3b8;">#${index + 1}</div>
                            <div style="font-size: 1.1rem; font-weight: bold;">${user.name}</div>
                        </div>
                        <div style="font-size: 1.1rem; font-weight: bold; color: #6ee7b7;">$${user.total_points.toFixed(2)}</div>
                    </div>
                `).join('');
            } catch (err) {
                container.innerHTML = `<div style="text-align: center; color: #fca5a5; padding: 2rem;">Failed to load leaderboard.</div>`;
                console.error('Error loading leaderboard:', err);
            }
        }
        
        function updateGamesDisplay(games) {
            const container = document.getElementById('gamesContainer');
            if (!games || games.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #94a3b8; padding: 2rem;">No games available for this week.</div>';
                return;
            }
            
            container.innerHTML = games.map((game) => {
                const gameId = game.id;
                const homeTeam = game.home_team;
                const awayTeam = game.away_team;
                const matchup = `${awayTeam} @ ${homeTeam}`;
                const gameTime = new Date(game.commence_time).toLocaleDateString('en-US', {
                    weekday: 'short',
                    month: 'short',
                    day: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit'
                });
                
                const fanduelBookmaker = game.bookmakers.find(b => b.key === 'fanduel');
                if (!fanduelBookmaker) return '';
                
                const h2h = fanduelBookmaker.markets.find(m => m.key === 'h2h');
                const spreads = fanduelBookmaker.markets.find(m => m.key === 'spreads');
                const totals = fanduelBookmaker.markets.find(m => m.key === 'totals');
                
                const awayML = h2h?.outcomes?.find(o => o.name === awayTeam)?.price || 'N/A';
                const homeML = h2h?.outcomes?.find(o => o.name === homeTeam)?.price || 'N/A';
                
                const awaySpreadPoint = spreads?.outcomes?.find(o => o.name === awayTeam)?.point;
                const homeSpreadPoint = spreads?.outcomes?.find(o => o.name === homeTeam)?.point;
                const awaySpreadOdds = spreads?.outcomes?.find(o => o.name === awayTeam)?.price || 'N/A';
                const homeSpreadOdds = spreads?.outcomes?.find(o => o.name === homeTeam)?.price || 'N/A';
                const awaySpreadPointFormatted = awaySpreadPoint !== undefined ? (awaySpreadPoint > 0 ? `+${awaySpreadPoint}` : awaySpreadPoint) : 'N/A';
                const homeSpreadPointFormatted = homeSpreadPoint !== undefined ? (homeSpreadPoint > 0 ? `+${homeSpreadPoint}` : homeSpreadPoint) : 'N/A';
                
                const overTotalPoint = totals?.outcomes?.find(o => o.name === 'Over')?.point;
                const underTotalPoint = totals?.outcomes?.find(o => o.name === 'Under')?.point;
                const overTotalOdds = totals?.outcomes?.find(o => o.name === 'Over')?.price || 'N/A';
                const underTotalOdds = totals?.outcomes?.find(o => o.name === 'Under')?.price || 'N/A';
                const overPointFormatted = overTotalPoint !== undefined ? `O${overTotalPoint}` : 'N/A';
                const underPointFormatted = underTotalPoint !== undefined ? `U${underTotalPoint}` : 'N/A';

                return `
                    <div class="game-card">
                        <div class="game-header">
                            <div class="game-matchup">${matchup}</div>
                            <div class="game-time">${gameTime}</div>
                        </div>
                        
                        <div class="team-row">
                            <div class="team-name">${awayTeam}</div>
                            <div class="bet-option" onclick="selectBet(event, '${gameId}', '${awayTeam}', 'moneyline', '${awayML}', null, '${matchup}')" data-bet="${gameId}-${awayTeam}-moneyline">${awayML !== 'N/A' && awayML > 0 ? '+' + awayML : awayML}</div>
                            <div class="bet-option" onclick="selectBet(event, '${gameId}', '${awayTeam}', 'spread', '${awaySpreadOdds}', ${awaySpreadPoint !== undefined ? awaySpreadPoint : null}, '${matchup}')" data-bet="${gameId}-${awayTeam}-spread">${awaySpreadPointFormatted}</div>
                            <div class="bet-option" onclick="selectBet(event, '${gameId}', 'Over', 'total', '${overTotalOdds}', ${overTotalPoint !== undefined ? overTotalPoint : null}, '${matchup}')" data-bet="${gameId}-Over-total">${overPointFormatted}</div>
                        </div>
                        
                        <div class="team-row">
                            <div class="team-name">${homeTeam}</div>
                            <div class="bet-option" onclick="selectBet(event, '${gameId}', '${homeTeam}', 'moneyline', '${homeML}', null, '${matchup}')" data-bet="${gameId}-${homeTeam}-moneyline">${homeML !== 'N/A' && homeML > 0 ? '+' + homeML : homeML}</div>
                            <div class="bet-option" onclick="selectBet(event, '${gameId}', '${homeTeam}', 'spread', '${homeSpreadOdds}', ${homeSpreadPoint !== undefined ? homeSpreadPoint : null}, '${matchup}')" data-bet="${gameId}-Under-total">${homeSpreadPointFormatted}</div>
                            <div class="bet-option" onclick="selectBet(event, '${gameId}', 'Under', 'total', '${underTotalOdds}', ${underTotalPoint !== undefined ? underTotalPoint : null}, '${matchup}')" data-bet="${gameId}-Under-total">${underPointFormatted}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Admin Functions
        // Mark bet result (admin only)
        async function markBetResult(user_pin, game_id, bet_type, team_picked, is_win) {
            if (!currentUser?.is_admin) return;
            const week_id = currentWeek?.id;
            if (!week_id) return;
            try {
                // Upsert result
                const { error } = await supabase
                    .from('bet_results')
                    .upsert({
                        user_pin,
                        week_id,
                        game_id,
                        bet_type,
                        team_picked,
                        is_win,
                        marked_at: new Date().toISOString()
                    }, { onConflict: ['user_pin', 'week_id', 'game_id', 'bet_type', 'team_picked'] });
                if (error) throw error;
                // Refresh board
                loadCurrentWeeksBets();
            } catch (err) {
                alert('Failed to mark result: ' + err.message);
                console.error('Mark result error:', err);
            }
        }
        async function loadOdds() {
            if (!currentUser?.is_admin) {
                showValidationMessage('You are not authorized to perform this action.');
                return;
            }
            const weekNumber = prompt('Enter week number (e.g., 1):');
            if (!weekNumber || isNaN(weekNumber) || weekNumber < 1) {
                alert('Please enter a valid week number.');
                return;
            }
            
            const btn = document.getElementById('loadOddsBtn');
            btn.disabled = true;
            btn.textContent = 'Loading Odds...';
            
            try {
                const response = await fetch(`https://api.the-odds-api.com/v4/sports/americanfootball_ncaaf/odds/?apiKey=5ac6ca934f3164bd862f5d44907f11f4&regions=us&markets=h2h,spreads,totals&oddsFormat=american&bookmakers=fanduel`);
                if (!response.ok) throw new Error('Failed to fetch odds from API');
                const oddsDataFromApi = await response.json();
                
                // Filter games to only include those within the next 7 days and apply the 68 game limit
                const now = new Date();
                const oneWeekFromNow = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
                const filteredGames = oddsDataFromApi.filter(game => {
                    const gameTime = new Date(game.commence_time);
                    return gameTime >= now && gameTime <= oneWeekFromNow;
                }).slice(0, 68);
                
                await supabase.from('betting_weeks').update({ is_active: false }).neq('id', 0);
                
                const deadline = new Date();
                deadline.setDate(deadline.getDate() + ((5 - deadline.getDay() + 7) % 7));
                deadline.setHours(11, 0, 0, 0);
                
                const { data: newWeek, error } = await supabase.from('betting_weeks').insert([{
                    week_number: parseInt(weekNumber),
                    year: new Date().getFullYear(),
                    api_data: { games: filteredGames },
                    betting_deadline: deadline.toISOString(),
                    is_active: true
                }]).select();
                
                if (error) throw error;
                currentWeek = newWeek[0];
                oddsData = filteredGames;
                updateGamesDisplay(oddsData);
                
                alert(`Successfully loaded odds for Week ${weekNumber}! Found ${oddsData.length} games.`);
            } catch (err) {
                alert('Failed to load odds: ' + err.message);
                console.error('Odds loading error:', err);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Load Odds';
            }
        }
        
        async function loadUsersForAdmin() {
            if (!currentUser?.is_admin) return;
            try {
                const { data, error } = await supabase.from('users').select('name, pin').order('name');
                if (error) throw error;
                
                const userDropdown = document.getElementById('userDropdown');
                userDropdown.innerHTML = '<option value="">Select a user</option>';
                data.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.pin;
                    option.textContent = user.name;
                    userDropdown.appendChild(option);
                });
            } catch (err) {
                console.error('Error loading users for admin panel:', err);
            }
        }

        async function updateUserPoints() {
            if (!currentUser?.is_admin) {
                showPointsMessage('You are not authorized to perform this action.');
                return;
            }
            const userPin = document.getElementById('userDropdown').value;
            const pointsInput = document.getElementById('pointsInput').value;
            const points = parseFloat(pointsInput);
            const btn = document.getElementById('updatePointsBtn');

            if (!userPin) {
                showPointsMessage('Please select a user.');
                return;
            }
            if (isNaN(points)) {
                showPointsMessage('Please enter a valid number for points.');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Updating...';

            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('total_points, name')
                    .eq('pin', userPin)
                    .single();
                if (error) throw error;
                
                const newTotalPoints = data.total_points + points;
                
                const { error: updateError } = await supabase
                    .from('users')
                    .update({ total_points: newTotalPoints })
                    .eq('pin', userPin);
                
                if (updateError) throw updateError;
                
                showPointsMessage(`Successfully updated points for ${data.name}! New total: ${newTotalPoints}`, 'success');
                document.getElementById('pointsInput').value = '';
                loadLeaderboard();
            } catch (err) {
                showPointsMessage('Failed to update points: ' + err.message);
                console.error('Points update error:', err);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Update Points';
            }
        }

        function showPointsMessage(message, type = 'error') {
            const messageEl = document.getElementById('pointsMessage');
            messageEl.textContent = message;
            messageEl.classList.remove('hidden');
            messageEl.classList.remove('validation-message', 'success-message');
            messageEl.classList.add(type === 'success' ? 'success-message' : 'validation-message');
            setTimeout(() => {
                messageEl.classList.add('hidden');
            }, 3000);
        }
        
        window.onclick = function(event) {
            const modal = document.getElementById('betSlipModal');
            if (event.target === modal) {
                closeBetSlip();
            }
        }
    </script>
</body>
</html>
